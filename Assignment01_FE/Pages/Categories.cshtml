@page
@model Assignment01_FE.Pages.CategoriesModel
@{
    ViewData["Title"] = "Categories";
}
<div class="row">
    <div class="col-md-12">
        <h2>Categories</h2>

        <!-- Success/Error Alerts -->
        <div id="alertContainer"></div>

        <form method="get" class="d-flex mb-3">
            <input name="search" value="@Model.Search" class="form-control me-2" placeholder="Search by name or description..." />
            <button type="submit" class="btn btn-primary">Search</button>
            @if (Model.CanManage)
            {
                <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCreateModal()">New</button>
            }
        </form>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Parent</th>
                    <th>Active</th>
                    <th>Articles</th>
                    @if (Model.CanManage)
                    {
                        <th>Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model.PagedCategories)
                {
                    <tr>
                        <td>@c.CategoryId</td>
                        <td>@c.CategoryName</td>
                        <td>@c.CategoryDesciption</td>
                        <td>@(c.ParentCategoryId?.ToString() ?? "-")</td>
                        <td>
                            <span class="badge bg-@(c.IsActive == true ? "success" : "secondary")">
                                @(c.IsActive == true ? "Active" : "Inactive")
                            </span>
                        </td>
                        <td>@c.ArticleCount</td>
                        @if (Model.CanManage)
                        {
                            <td>
                                <button class="btn btn-sm btn-info" onclick="openEditModal(@c.CategoryId)">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete(@c.CategoryId, '@c.CategoryName')">Delete</button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <!-- Pagination -->
        <nav>
            <ul class="pagination">
                <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                    <a class="page-link" asp-route-page="@(Model.Page-1)" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">Previous</a>
                </li>
                @for (var i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(Model.Page == i ? "active" : "")">
                        <a class="page-link" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">@i</a>
                    </li>
                }
                <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" asp-route-page="@(Model.Page+1)" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" />
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" id="categoryName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea id="categoryDescription" class="form-control" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parent Category ID</label>
                        <input type="number" id="parentCategoryId" class="form-control" />
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="isActive" class="form-check-input" />
                        <label class="form-check-label">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isEditMode = false;

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('categoryModalTitle').textContent = 'Create Category';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('isActive').checked = true;
        }

        async function openEditModal(id) {
            isEditMode = true;
            document.getElementById('categoryModalTitle').textContent = 'Edit Category';
            
            try {
                const response = await fetch(`https://localhost:7215/api/category/${id}`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const category = await response.json();
                    if (category) {
                        document.getElementById('categoryId').value = category.categoryId;
                        document.getElementById('categoryName').value = category.categoryName || '';
                        document.getElementById('categoryDescription').value = category.categoryDesciption || '';
                        document.getElementById('parentCategoryId').value = category.parentCategoryId || '';
                        document.getElementById('isActive').checked = category.isActive || false;
                    }
                }
            } catch (error) {
                showAlert('Error loading category details', 'danger');
            }
        }

        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                categoryName: document.getElementById('categoryName').value,
                categoryDesciption: document.getElementById('categoryDescription').value,
                parentCategoryId: document.getElementById('parentCategoryId').value ? parseInt(document.getElementById('parentCategoryId').value) : null,
                isActive: document.getElementById('isActive').checked
            };

            try {
                let response;
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                if (isEditMode) {
                    const id = document.getElementById('categoryId').value;
                    response = await fetch(`https://localhost:7215/api/category/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('https://localhost:7215/api/category', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showAlert(isEditMode ? 'Category updated successfully.' : 'Category created successfully.', 'success');
                    $('#categoryModal').modal('hide');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorText;
                    } catch {}
                    showAlert(errorMessage, 'danger');
                }
            } catch (error) {
                showAlert('Error saving category', 'danger');
            }
        }

        function confirmDelete(id, name) {
            if (confirm(`Are you sure you want to delete category "${name}"?`)) {
                deleteCategory(id);
            }
        }

        async function deleteCategory(id) {
            try {
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                const response = await fetch(`https://localhost:7215/api/category/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                if (response.ok) {
                    showAlert('Category deleted successfully.', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorText;
                    } catch {}
                    showAlert(errorMessage, 'danger');
                }
            } catch (error) {
                showAlert('Error deleting category', 'danger');
            }
        }
    </script>
}
