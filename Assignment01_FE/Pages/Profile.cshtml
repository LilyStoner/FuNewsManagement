@page
@model Assignment1_PRN232_FE.Pages.ProfileModel
@{
    ViewData["Title"] = "My Profile";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">My Profile</h1>
                    <p class="text-muted">Manage your account information and settings</p>
                </div>
                <div>
                    @if (Model.CurrentUser?.AccountRole == 1 || Model.CurrentUser?.AccountRole == 2)
                    {
                        <a href="/Staff/Dashboard" class="btn btn-outline-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    }
                    else
                    {
                        <a href="/Admin/Dashboard" class="btn btn-outline-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user me-2"></i>Profile Information
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="UpdateProfile">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="UpdateProfile.AccountName" class="form-label">Full Name *</label>
                                <input asp-for="UpdateProfile.AccountName" class="form-control" />
                                <span asp-validation-for="UpdateProfile.AccountName" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="UpdateProfile.AccountEmail" class="form-label">Email Address *</label>
                                <input asp-for="UpdateProfile.AccountEmail" type="email" class="form-control" />
                                <span asp-validation-for="UpdateProfile.AccountEmail" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Role</label>
                                <div class="form-control-plaintext">
                                    @switch (Model.CurrentUser?.AccountRole)
                                    {
                                        case 1:
                                            <span class="badge bg-primary">
                                                <i class="fas fa-user-tie me-1"></i>Staff
                                            </span>
                                            break;
                                        case 2:
                                            <span class="badge bg-info">
                                                <i class="fas fa-chalkboard-teacher me-1"></i>Lecturer
                                            </span>
                                            break;
                                        default:
                                            <span class="badge bg-danger">
                                                <i class="fas fa-user-shield me-1"></i>Administrator
                                            </span>
                                            break;
                                    }
                                </div>
                                <div class="form-text">Your role cannot be changed</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Account ID</label>
                                <div class="form-control-plaintext">
                                    <code>#@Model.CurrentUser?.AccountId</code>
                                </div>
                                <div class="form-text">Your unique account identifier</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Change Password -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="ChangePassword">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="ChangePassword.CurrentPassword" class="form-label">Current Password *</label>
                                <input asp-for="ChangePassword.CurrentPassword" type="password" class="form-control" />
                                <span asp-validation-for="ChangePassword.CurrentPassword" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label asp-for="ChangePassword.NewPassword" class="form-label">New Password *</label>
                                <input asp-for="ChangePassword.NewPassword" type="password" class="form-control" 
                                       minlength="6" />
                                <span asp-validation-for="ChangePassword.NewPassword" class="text-danger"></span>
                                <div class="form-text">At least 6 characters</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label asp-for="ChangePassword.ConfirmPassword" class="form-label">Confirm Password *</label>
                                <input asp-for="ChangePassword.ConfirmPassword" type="password" class="form-control" />
                                <span asp-validation-for="ChangePassword.ConfirmPassword" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-key me-2"></i>Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Profile Stats -->
        <div class="col-lg-4">
            <!-- User Info Card -->
            <div class="card shadow mb-4">
                <div class="card-body text-center">
                    <div class="avatar-circle mb-3">
                        <i class="fas fa-user fa-2x"></i>
                    </div>
                    <h5 class="card-title">@Model.CurrentUser?.AccountName</h5>
                    <p class="text-muted">@Model.CurrentUser?.AccountEmail</p>
                    
                    @switch (Model.CurrentUser?.AccountRole)
                    {
                        case 1:
                            <span class="badge bg-primary fs-6">Staff Member</span>
                            break;
                        case 2:
                            <span class="badge bg-info fs-6">Lecturer</span>
                            break;
                        default:
                            <span class="badge bg-danger fs-6">Administrator</span>
                            break;
                    }
                </div>
            </div>

            <!-- Activity Stats (for Staff/Lecturer) -->
            @if (Model.CurrentUser?.AccountRole == 1 || Model.CurrentUser?.AccountRole == 2)
            {
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Activity Statistics
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <div class="stat-number text-primary">@Model.TotalArticles</div>
                                    <div class="stat-label">Total Articles</div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-item">
                                    <div class="stat-number text-success">@Model.PublishedArticles</div>
                                    <div class="stat-label">Published</div>
                                </div>
                            </div>
                        </div>
                        
                        @if (Model.LastArticleDate.HasValue)
                        {
                            <hr>
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Last article: @Model.LastArticleDate?.ToString("MMM dd, yyyy")
                                </small>
                            </div>
                        }
                        
                        <div class="mt-3 d-grid">
                            <a href="/Staff/Articles" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-newspaper me-2"></i>Manage Articles
                            </a>
                        </div>
                    </div>
                </div>
            }

            <!-- Account Actions -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cogs me-2"></i>Account Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.CurrentUser?.AccountRole == 1 || Model.CurrentUser?.AccountRole == 2)
                        {
                            <a href="/Staff/Articles/Create" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-2"></i>Create Article
                            </a>
                            <a href="/Staff/Categories" class="btn btn-info btn-sm">
                                <i class="fas fa-folder me-2"></i>Manage Categories
                            </a>
                        }
                        
                        <a href="/News/Active" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-newspaper me-2"></i>View All News
                        </a>
                        
                        <hr class="my-2">
                        
                        <a href="/Logout" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Password strength indicator
        $(document).ready(function() {
            $('#ChangePassword_NewPassword').on('input', function() {
                var password = $(this).val();
                var strength = checkPasswordStrength(password);
                
                // Remove existing feedback
                $(this).removeClass('is-invalid is-valid');
                $(this).siblings('.password-strength').remove();
                
                if (password.length > 0) {
                    var strengthClass = strength.score < 2 ? 'text-danger' : 
                                      strength.score < 4 ? 'text-warning' : 'text-success';
                    
                    $(this).after(`<div class="password-strength small ${strengthClass} mt-1">
                        <i class="fas fa-shield-alt me-1"></i>${strength.text}
                    </div>`);
                    
                    if (strength.score >= 2) {
                        $(this).addClass('is-valid');
                    } else if (password.length >= 6) {
                        $(this).addClass('is-invalid');
                    }
                }
            });
            
            // Confirm password validation
            $('#ChangePassword_ConfirmPassword').on('input', function() {
                var password = $('#ChangePassword_NewPassword').val();
                var confirm = $(this).val();
                
                $(this).removeClass('is-invalid is-valid');
                
                if (confirm.length > 0) {
                    if (password === confirm) {
                        $(this).addClass('is-valid');
                    } else {
                        $(this).addClass('is-invalid');
                    }
                }
            });
        });

        function checkPasswordStrength(password) {
            var score = 0;
            var feedback = [];
            
            if (password.length >= 8) score++;
            if (password.match(/[a-z]/)) score++;
            if (password.match(/[A-Z]/)) score++;
            if (password.match(/[0-9]/)) score++;
            if (password.match(/[^A-Za-z0-9]/)) score++;
            
            var text = '';
            switch (score) {
                case 0:
                case 1:
                    text = 'Very Weak';
                    break;
                case 2:
                    text = 'Weak';
                    break;
                case 3:
                    text = 'Fair';
                    break;
                case 4:
                    text = 'Good';
                    break;
                case 5:
                    text = 'Strong';
                    break;
            }
            
            return { score: score, text: text };
        }
    </script>
}