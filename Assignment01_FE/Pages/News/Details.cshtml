@page "{id}"
@model Assignment1_PRN232_FE.Pages.News.DetailsModel
@{
    ViewData["Title"] = Model.Article?.NewsTitle ?? "Article Not Found";
}

@if (Model.Article != null)
{
    <!-- Article Header -->
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/News/Active">News</a></li>
                        <li class="breadcrumb-item"><a href="/News/Active?categoryId=@Model.Article.CategoryId">@Model.Article.CategoryName</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Article</li>
                    </ol>
                </nav>

                <!-- Article Content -->
                <article class="news-article">
                    <!-- Status Badge (for logged in users) -->
                    @if (HttpContext.Session.GetString("AuthToken") != null && Model.Article.NewsStatus != true)
                    {
                        <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                            <i class="fas fa-eye-slash me-2"></i>
                            <div>
                                <strong>Draft Article:</strong> This article is not published and only visible to you.
                            </div>
                        </div>
                    }

                    <!-- Article Header -->
                    <header class="article-header mb-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-primary category-badge">@Model.Article.CategoryName</span>
                            <div class="article-actions">
                                @if (HttpContext.Session.GetString("AuthToken") != null)
                                {
                                    var userRole = HttpContext.Session.GetString("UserRole");
                                    var userId = HttpContext.Session.GetInt32("UserId");
                                    
                                    @if (userRole == "1" && Model.Article.CreatedById == userId)
                                    {
                                        <a href="/Staff/Articles/Edit/@Model.Article.NewsArticleId" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                    }
                                    else if (userRole == "Admin")
                                    {
                                        <a href="/Staff/Articles/Edit/@Model.Article.NewsArticleId" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </a>
                                    }
                                }
                                
                                <button class="btn btn-sm btn-outline-secondary" onclick="shareArticle()">
                                    <i class="fas fa-share me-1"></i>Share
                                </button>
                            </div>
                        </div>

                        <h1 class="article-title">@Model.Article.NewsTitle</h1>
                        
                        <p class="article-headline text-muted fs-5 mb-4">@Model.Article.Headline</p>
                        
                        <div class="article-meta">
                            <div class="d-flex flex-wrap align-items-center text-muted">
                                <div class="me-4 mb-2">
                                    <i class="fas fa-user me-1"></i>
                                    <span>@Model.Article.CreatedByName</span>
                                </div>
                                <div class="me-4 mb-2">
                                    <i class="fas fa-calendar me-1"></i>
                                    <time datetime="@Model.Article.CreatedDate?.ToString("yyyy-MM-dd")">
                                        @Model.Article.CreatedDate?.ToString("MMMM dd, yyyy")
                                    </time>
                                </div>
                                @if (Model.Article.ModifiedDate.HasValue && Model.Article.ModifiedDate != Model.Article.CreatedDate)
                                {
                                    <div class="me-4 mb-2">
                                        <i class="fas fa-edit me-1"></i>
                                        <span>Updated @Model.Article.ModifiedDate?.ToString("MMM dd, yyyy")</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(Model.Article.NewsSource))
                                {
                                    <div class="mb-2">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        <span>Source: @Model.Article.NewsSource</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </header>

                    <!-- Article Body -->
                    <div class="article-content">
                        @if (!string.IsNullOrEmpty(Model.Article.NewsContent))
                        {
                            @Html.Raw(Model.Article.NewsContent)
                        }
                        else
                        {
                            <p class="text-muted fst-italic">No content available for this article.</p>
                        }
                    </div>

                    <!-- Tags -->
                    @if (Model.Article.Tags.Any())
                    {
                        <div class="article-tags mt-4 pt-4 border-top">
                            <h6 class="text-muted mb-3">Tags:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var tag in Model.Article.Tags)
                                {
                                    <a href="/News/Active?search=@tag.TagName" class="badge bg-light text-dark text-decoration-none tag-badge">
                                        <i class="fas fa-tag me-1"></i>@tag.TagName
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </article>
            </div>
        </div>

        <!-- Related Articles -->
        @if (Model.RelatedArticles.Any() || Model.SameCategoryArticles.Any())
        {
            <div class="row justify-content-center mt-5">
                <div class="col-lg-10">
                    <hr class="my-5">
                    <h3 class="text-center mb-4">Related Articles</h3>
                    
                    <div class="row">
                        @{
                            var articlesToShow = Model.RelatedArticles.Any() ? Model.RelatedArticles : Model.SameCategoryArticles;
                        }
                        
                        @foreach (var article in articlesToShow)
                        {
                            <div class="col-md-4 mb-4">
                                <div class="card h-100 related-article-card">
                                    <div class="card-body">
                                        <span class="badge bg-secondary mb-2">@article.CategoryName</span>
                                        <h6 class="card-title">
                                            <a href="/News/Details/@article.NewsArticleId" class="text-decoration-none">
                                                @article.NewsTitle
                                            </a>
                                        </h6>
                                        <p class="card-text text-muted small">@article.Headline</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-user me-1"></i>@article.CreatedByName
                                            </small>
                                            <small class="text-muted">
                                                @article.CreatedDate?.ToString("MMM dd")
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <div class="text-center mt-4">
                        <a href="/News/Active" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to All Articles
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <!-- Article Not Found -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-muted mb-4"></i>
                    <h2>Article Not Found</h2>
                    <p class="text-muted mb-4">The article you're looking for doesn't exist or has been removed.</p>
                    <div>
                        <a href="/News/Active" class="btn btn-primary me-3">
                            <i class="fas fa-arrow-left me-2"></i>Back to News
                        </a>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function shareArticle() {
            if (navigator.share) {
                navigator.share({
                    title: document.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href).then(function() {
                    alert('Article URL copied to clipboard!');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    shareArticle();
                }
            });
        });
    </script>
}