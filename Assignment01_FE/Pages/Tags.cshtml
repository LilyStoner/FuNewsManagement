@page
@model Assignment01_FE.Pages.TagsModel
@{
    ViewData["Title"] = "Tags";
}
<div class="row">
    <div class="col-md-12">
        <h2>Tags</h2>

        <!-- Success/Error Alerts -->
        <div id="alertContainer"></div>

        <form method="get" class="d-flex mb-3">
            <input name="search" value="@Model.Search" class="form-control me-2" placeholder="Search by tag name..." />
            <button type="submit" class="btn btn-primary">Search</button>
            @if (Model.CanManage)
            {
                <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#tagModal" onclick="openCreateModal()">New</button>
            }
        </form>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Note</th>
                    <th>Articles</th>
                    @if (Model.CanManage)
                    {
                        <th>Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.PagedTags)
                {
                    <tr>
                        <td>@t.TagId</td>
                        <td>@t.TagName</td>
                        <td>@t.Note</td>
                        <td>@t.ArticleCount</td>
                        @if (Model.CanManage)
                        {
                            <td>
                                <button class="btn btn-sm btn-info" onclick="openEditModal(@t.TagId)">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete(@t.TagId, '@t.TagName')">Delete</button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <!-- Pagination -->
        <nav>
            <ul class="pagination">
                <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
                    <a class="page-link" asp-route-page="@(Model.Page-1)" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">Previous</a>
                </li>
                @for (var i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(Model.Page == i ? "active" : "")">
                        <a class="page-link" asp-route-page="@i" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">@i</a>
                    </li>
                }
                <li class="page-item @(Model.Page == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" asp-route-page="@(Model.Page+1)" asp-route-search="@Model.Search" asp-route-pageSize="@Model.PageSize">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Tag Modal -->
<div class="modal fade" id="tagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagModalTitle">Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="tagForm">
                    <input type="hidden" id="tagId" />
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" id="tagName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea id="tagNote" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTag()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isEditMode = false;

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('tagModalTitle').textContent = 'Create Tag';
            document.getElementById('tagForm').reset();
            document.getElementById('tagId').value = '';
        }

        async function openEditModal(id) {
            isEditMode = true;
            document.getElementById('tagModalTitle').textContent = 'Edit Tag';
            
            try {
                const response = await fetch(`https://localhost:7215/api/tag/${id}`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const tag = await response.json();
                    if (tag) {
                        document.getElementById('tagId').value = tag.tagId;
                        document.getElementById('tagName').value = tag.tagName || '';
                        document.getElementById('tagNote').value = tag.note || '';
                    }
                }
            } catch (error) {
                showAlert('Error loading tag details', 'danger');
            }
        }

        async function saveTag() {
            const form = document.getElementById('tagForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                tagName: document.getElementById('tagName').value,
                note: document.getElementById('tagNote').value
            };

            try {
                let response;
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                if (isEditMode) {
                    const id = document.getElementById('tagId').value;
                    response = await fetch(`https://localhost:7215/api/tag/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('https://localhost:7215/api/tag', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showAlert(isEditMode ? 'Tag updated successfully.' : 'Tag created successfully.', 'success');
                    $('#tagModal').modal('hide');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorText;
                    } catch {}
                    showAlert(errorMessage, 'danger');
                }
            } catch (error) {
                showAlert('Error saving tag', 'danger');
            }
        }

        function confirmDelete(id, name) {
            if (confirm(`Are you sure you want to delete tag "${name}"?`)) {
                deleteTag(id);
            }
        }

        async function deleteTag(id) {
            try {
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                const response = await fetch(`https://localhost:7215/api/tag/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                if (response.ok) {
                    showAlert('Tag deleted successfully.', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    let errorMessage = errorText;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorText;
                    } catch {}
                    showAlert(errorMessage, 'danger');
                }
            } catch (error) {
                showAlert('Error deleting tag', 'danger');
            }
        }
    </script>
}
