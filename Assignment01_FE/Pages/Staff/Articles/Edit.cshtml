@page "{id}"
@model Assignment1_PRN232_FE.Pages.Staff.Articles.EditModel
@{
    ViewData["Title"] = "Edit Article";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Staff/Dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/Staff/Articles">My Articles</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Article</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Edit Article</h1>
                    <p class="text-muted">Modify your existing news article</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/News/Details/@Model.Article.NewsArticleId" class="btn btn-outline-info" target="_blank">
                        <i class="fas fa-eye me-2"></i>Preview
                    </a>
                    <a href="/Staff/Articles" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Articles
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-white">Edit Article Information</h6>
                    <small class="text-white-50">ID: @Model.Article.NewsArticleId</small>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label asp-for="Article.NewsTitle" class="form-label">Article Title *</label>
                                    <input asp-for="Article.NewsTitle" class="form-control" />
                                    <span asp-validation-for="Article.NewsTitle" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Article.Headline" class="form-label">Headline *</label>
                                    <input asp-for="Article.Headline" class="form-control" />
                                    <span asp-validation-for="Article.Headline" class="text-danger"></span>
                                    <div class="form-text">A short, catchy headline that summarizes the article.</div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Article.NewsContent" class="form-label">Content</label>
                                    <textarea asp-for="Article.NewsContent" class="form-control" rows="12"></textarea>
                                    <span asp-validation-for="Article.NewsContent" class="text-danger"></span>
                                    <div class="form-text">
                                        <span id="contentCounter">0</span>/4000 characters
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Article.NewsSource" class="form-label">News Source</label>
                                    <input asp-for="Article.NewsSource" class="form-control" />
                                    <span asp-validation-for="Article.NewsSource" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Article.CategoryId" class="form-label">Category *</label>
                                    <select asp-for="Article.CategoryId" class="form-select">
                                        <option value="">Select Category</option>
                                        @foreach (var category in Model.Categories)
                                        {
                                            <option value="@category.CategoryId">@category.CategoryName</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Article.CategoryId" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                        @foreach (var tag in Model.Tags)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="Article.SelectedTagIds" value="@tag.TagId" 
                                                       id="tag_@tag.TagId"
                                                       checked="@(Model.Article.SelectedTagIds.Contains(tag.TagId))">
                                                <label class="form-check-label" for="tag_@tag.TagId">
                                                    @tag.TagName
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <div class="form-text">Select relevant tags for your article.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Publication Status</label>
                                    <div class="form-check">
                                        <input asp-for="Article.NewsStatus" type="checkbox" class="form-check-input" id="newsStatus">
                                        <label asp-for="Article.NewsStatus" class="form-check-label" for="newsStatus">
                                            Published
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        @if (Model.Article.NewsStatus == true)
                                        {
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>This article is currently published
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-warning">
                                                <i class="fas fa-edit me-1"></i>This article is currently a draft
                                            </span>
                                        }
                                    </div>
                                </div>

                                <div class="preview-section">
                                    <h6 class="text-muted mb-2">Article Preview</h6>
                                    <div class="card">
                                        <div class="card-body p-3">
                                            <h6 class="card-title" id="previewTitle">@Model.Article.NewsTitle</h6>
                                            <p class="card-text text-muted small" id="previewHeadline">@Model.Article.Headline</p>
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted" id="previewCategory">Category</small>
                                                <small class="text-muted" id="previewStatus">
                                                    @(Model.Article.NewsStatus == true ? "Published" : "Draft")
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success me-2" name="action" value="save">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                                @if (Model.Article.NewsStatus != true)
                                {
                                    <button type="submit" class="btn btn-primary" name="action" value="publish">
                                        <i class="fas fa-upload me-2"></i>Save & Publish
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-warning" name="action" value="unpublish">
                                        <i class="fas fa-eye-slash me-2"></i>Save & Unpublish
                                    </button>
                                }
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Article History (Future Enhancement) -->
            <div class="card shadow mt-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Article Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Article ID:</strong><br>
                            <code>@Model.Article.NewsArticleId</code>
                        </div>
                        <div class="col-md-4">
                            <strong>Current Status:</strong><br>
                            @if (Model.Article.NewsStatus == true)
                            {
                                <span class="badge bg-success">Published</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Draft</span>
                            }
                        </div>
                        <div class="col-md-4">
                            <strong>Last Modified:</strong><br>
                            <small class="text-muted">Just updated</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        $(document).ready(function() {
            // Initialize TinyMCE
            tinymce.init({
                selector: '#Article_NewsContent',
                height: 300,
                plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
                toolbar_mode: 'floating',
                toolbar: 'undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
                setup: function (editor) {
                    editor.on('input', function () {
                        updatePreview();
                        updateCharCount();
                    });
                }
            });

            function updateCharCount() {
                const content = tinymce.get('Article_NewsContent').getContent({format: 'text'});
                $('#contentCounter').text(content.length);
                
                if (content.length > 4000) {
                    $('#contentCounter').addClass('text-danger');
                } else {
                    $('#contentCounter').removeClass('text-danger');
                }
            }

            function updatePreview() {
                const title = $('#Article_NewsTitle').val() || '@Model.Article.NewsTitle';
                const headline = $('#Article_Headline').val() || '@Model.Article.Headline';
                const categoryText = $('#Article_CategoryId option:selected').text() || 'Category';
                const isPublished = $('#Article_NewsStatus').is(':checked');
                
                $('#previewTitle').text(title);
                $('#previewHeadline').text(headline);
                $('#previewCategory').text(categoryText);
                $('#previewStatus').text(isPublished ? 'Published' : 'Draft')
                    .removeClass('text-success text-muted')
                    .addClass(isPublished ? 'text-success' : 'text-muted');
            }

            // Bind preview updates
            $('#Article_NewsTitle, #Article_Headline').on('input', updatePreview);
            $('#Article_CategoryId, #Article_NewsStatus').on('change', updatePreview);

            // Handle different save actions
            $('button[name="action"][value="save"]').click(function() {
                // Keep current status
            });
            
            $('button[name="action"][value="publish"]').click(function() {
                $('#Article_NewsStatus').prop('checked', true);
            });
            
            $('button[name="action"][value="unpublish"]').click(function() {
                $('#Article_NewsStatus').prop('checked', false);
            });

            // Initial setup
            updateCharCount();
            updatePreview();
        });
    </script>
}

<style>
.preview-section {
    position: sticky;
    top: 20px;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-success {
    background: linear-gradient(135deg, #56CCF2 0%, #2F80ED 100%);
    border: none;
}

.breadcrumb {
    background: transparent;
    padding: 0;
}

.breadcrumb a {
    color: #667eea;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

#contentCounter.text-danger {
    font-weight: bold;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.card {
    border: none;
    border-radius: 15px;
}
</style>