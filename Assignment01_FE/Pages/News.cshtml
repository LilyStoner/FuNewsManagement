@page
@model Assignment01_FE.Pages.NewsModel
@{
    ViewData["Title"] = "News";
}
<div class="row">
    <div class="col-md-12">
        <h2>News Articles</h2>

        <!-- Success/Error Alerts -->
        <div id="alertContainer"></div>

        <div class="d-flex mb-3">
            <form method="get" class="d-flex w-100">
                <input name="Search" value="@Model.Search" class="form-control me-2" placeholder="Search articles..." />
                <button type="submit" class="btn btn-primary">Search</button>
                @if (Model.CanManage)
                {
                    <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#newsModal" onclick="openCreateModal()">New Article</button>
                }
            </form>
        </div>

        <table class="table table-bordered" id="newsTable">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Headline</th>
                    <th>Author</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Created Date</th>
                    @if (Model.CanManage)
                    {
                        <th>Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var n in Model.News)
                {
                    <tr>
                        <td>@n.NewsTitle</td>
                        <td>@n.Headline</td>
                        <td>@n.AuthorName</td>
                        <td>@n.CategoryName</td>
                        <td>
                            <span class="badge bg-@(n.NewsStatus == true ? "success" : "secondary")">
                                @(n.NewsStatus == true ? "Published" : "Draft")
                            </span>
                        </td>
                        <td>@(n.CreatedDate?.ToString("MMM dd, yyyy"))</td>
                        @if (Model.CanManage)
                        {
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewNews('@n.NewsArticleId')">View</button>
                                <button class="btn btn-sm btn-warning" onclick="openEditModal('@n.NewsArticleId')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('@n.NewsArticleId', '@n.NewsTitle')">Delete</button>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        @if (!Model.News.Any())
        {
            <div class="text-center py-4">
                <p class="text-muted">No articles found.</p>
            </div>
        }

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center">
            <div>
                @if (Model.Page > 1)
                {
                    <a asp-page="/News" asp-route-Page="@(Model.Page-1)" asp-route-Search="@Model.Search" asp-route-PageSize="@Model.PageSize" class="btn btn-sm btn-secondary">Previous</a>
                }
            </div>
            <div>
                Page @Model.Page
            </div>
            <div>
                @if (!string.IsNullOrEmpty(Model.NextLink) || Model.TotalPages > Model.Page)
                {
                    <a asp-page="/News" asp-route-Page="@(Model.Page+1)" asp-route-Search="@Model.Search" asp-route-PageSize="@Model.PageSize" class="btn btn-sm btn-secondary">Next</a>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.NextLink))
        {
            <div class="mt-2">
                <small class="text-muted">More results available</small>
            </div>
        }
    </div>
</div>

<!-- News Modal -->
<div class="modal fade" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsModalTitle">News Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newsForm">
                    <input type="hidden" id="newsId" />
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" id="newsTitle" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Headline *</label>
                        <input type="text" id="headline" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea id="newsContent" class="form-control" rows="5"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Source</label>
                        <input type="text" id="newsSource" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category ID</label>
                        <input type="number" id="categoryId" class="form-control" />
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="newsStatus" class="form-check-input" />
                        <label class="form-check-label">Published</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNews()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isEditMode = false;

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('newsModalTitle').textContent = 'Create News Article';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
        }

        async function openEditModal(id) {
            isEditMode = true;
            document.getElementById('newsModalTitle').textContent = 'Edit News Article';
            
            // Load news details via API
            try {
                const response = await fetch(`https://localhost:7215/api/news/${id}`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const news = await response.json();
                    if (news) {
                        document.getElementById('newsId').value = news.newsArticleId;
                        document.getElementById('newsTitle').value = news.newsTitle || '';
                        document.getElementById('headline').value = news.headline || '';
                        document.getElementById('newsContent').value = news.newsContent || '';
                        document.getElementById('newsSource').value = news.newsSource || '';
                        document.getElementById('categoryId').value = news.categoryId || '';
                        document.getElementById('newsStatus').checked = news.newsStatus || false;
                    }
                }
            } catch (error) {
                showAlert('Error loading news details', 'danger');
            }
        }

        async function saveNews() {
            const form = document.getElementById('newsForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                newsTitle: document.getElementById('newsTitle').value,
                headline: document.getElementById('headline').value,
                newsContent: document.getElementById('newsContent').value,
                newsSource: document.getElementById('newsSource').value,
                categoryId: document.getElementById('categoryId').value ? parseInt(document.getElementById('categoryId').value) : null,
                newsStatus: document.getElementById('newsStatus').checked
            };

            try {
                let response;
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                if (isEditMode) {
                    const id = document.getElementById('newsId').value;
                    response = await fetch(`https://localhost:7215/api/news/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Generate a simple ID for new articles
                    data.newsArticleId = Date.now().toString(36);
                    
                    response = await fetch('https://localhost:7215/api/news', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showAlert(isEditMode ? 'News updated successfully.' : 'News created successfully.', 'success');
                    $('#newsModal').modal('hide');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    showAlert(errorText || 'Error saving news', 'danger');
                }
            } catch (error) {
                showAlert('Error saving news', 'danger');
            }
        }

        function confirmDelete(id, title) {
            if (confirm(`Are you sure you want to delete "${title}"?`)) {
                deleteNews(id);
            }
        }

        async function deleteNews(id) {
            try {
                const token = '@Html.Raw(HttpContext.Session.GetString("auth_token"))';
                
                const response = await fetch(`https://localhost:7215/api/news/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });

                if (response.ok) {
                    showAlert('News deleted successfully.', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    showAlert(errorText || 'Error deleting news', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting news', 'danger');
            }
        }

        function viewNews(id) {
            window.open(`https://localhost:7215/api/news/${id}`, '_blank');
        }
    </script>
}
